/**
 * @preserve The Markup Markdown Preview Module
 * @desc Everything needed to handle the preview. Mostly cache and media rules handlers
 * @author Pierre-Henri Lavigne <lavigne.pierrehenri@proton.me>
 * @version 1.1.3
 * @license GPL 3 - https://www.gnu.org/licenses/gpl-3.0.html#license-text
 */
(u=>{var m={};function a(t){var a=this,r=(a.isReady=0,u(window).on("resize.mmd_preview",function(t){a.clipbox(t)}),u("#mmd_preview-css").length||u("head").append('<style type="text/css" id="mmd_preview-css"></style>'),a.previewSheet=document.getElementById("mmd_preview-css")||!1,t.base_url&&t.callbacks&&(a.base_url=t.base_url,a.callbacks=t.callbacks,a.isReady=1),[]),s={gallery:"renderGallery",videoPlaylist:"renderVideoPlaylist",audioPlaylist:"renderAudioPlaylist",convertImage:"convertHTMLImage",convertAudio:"convertAudioShortcode",convertVideo:"convertVideoShortcode",convertHeading:"convertHeadingTags",convertLatexFormulas:"renderLatexSnippets",convertMermaidFormulas:"renderMermaidSnippets",convertCodeFences:"renderCodeFencesSnippets"};return{flushQueue:function(){r=[]},add2Queue:function(t,e,i){var n=a.hashString(e||"");return m&&m[n]?m[n].join(""):t&&s[t]?(r.push([s[t],e||"",i||0]),"convertCodeFences"===t?e:""):void 0},runQueue:function(){for(var t,e=0;e<r.length;e++)t=r[e],a[t[0]](t[1],t[2])},processTask:function(t,e,i){return t&&s[t]?a[s[t]](e||"",i||0):""}}}a.prototype.hashString=function(t){for(var e=0,i=t.length;i--;)e=(e=(e+=t.charCodeAt(i))+(e<<10))^e>>6;return"t"+(e=(e=(e+=e<<3)^e>>11)+(e<<15))},a.prototype.clipbox=function(t){var e=[];u(".tmp_media").each(function(){e.push('div[data-pointer="'+u(this).attr("data-pointer")+'"]{min-height:'+Math.ceil(u(this).height())+"px}")}),e.push(".tmp_span_block{display:block}"),e.push(".tmp_span_inline{display:inline-block;vertical-align:baseline}"),this.previewSheet.innerText=e.join("")},a.prototype.extractExtra=function(t){if(!t||!t.length)return!1;var e=t.match(/([^\s][\#\.]*[a-zA-Z0-9-_=]+[^\W]*)/g);if(!e||!e.length)return!1;for(var i,n={},a=0;a<e.length;a++)i=e[a],/^#/.test(i)?(n.id=n.id||"",n.id+=i.replace("#","")):/^\./.test(i)?(n.class=n.class||"",n.class+=" "+i.replace(".","")):/\=/.test(i)&&(n[(i=i.split("="))[0]]=i[1]);var r,s=[];for(r in n)s.push(r+'="'+n[r].replace(/^\s*|\s*$/,"")+'"');return" "+s.join(" ")},a.prototype.convertHeadingTags=function(t){var e,i=this.hashString(t);return m&&m[i]?m[i].join(""):(e=t.match(/<h(\d)[^\>]*>(.*?)\{([^\}]+)\}<\/h\d>/))&&e.length&&4===e.length?(e=["<h"+e[1],this.extractExtra(e[3])||"",">",e[2],"</h"+e[1]+">"],(m[i]=e).join("")):(m[i]=[t],t)},a.prototype.renderGallery=function(a,r){var i=this,n=i.hashString(a),t=(a||"").match(/ids\=\"(.*?)\"/);if(t&&t[1]){for(var e,s={size:"thumbnail",columns:3,link:"none"},o=function(t){for(var e=[],i=(e.push(['<div id="gallery-'+r+'"',' class="gallery galleryid-'+r," gallery-columns-"+s.columns," gallery-size-"+s.size,'" data-shortcode="'+encodeURIComponent(a)+'">'].join("")),[]),n=0;n<t.length;n++)i.push(l(wp.media.attachment(t[n]).attributes));return i.length?((e=e.concat(i)).push("</div>"),e):""},l=function(t){var e;return t&&t.sizes?((e=['<figure class="gallery-item">']).push('<div class="gallery-icon '+(t.width>t.height?"landscape":"portrait")+'">'),"none"!==s.link&&e.push('<a href="'+("file"===s.link?t.url:t.link)+'" target="_blank">'),e.push(['<img src="'+(t.sizes[s.size]||t.sizes.thumbnail).url+'"',' alt="'+(t.alt||t.title)+'"',' width="'+(t.sizes[s.size].width||t.width)+'"',' height="'+(t.sizes[s.size].height||t.height)+'"',t.caption?' aria-describedby="gallery-'+r+"-"+t.id+'"':"",'">'].join("")),"none"!==s.link&&e.push("</a>"),e.push("</div>"),t.caption&&e.push(['<figcaption class="wp-caption-text gallery-caption" id="gallery-'+r+"-"+t.id+'">',t.caption,"</figcaption>"].join("")),e.push("</figure>"),e.join("")):""},c=(/columns/.test(a)&&(e=a.match(/columns\=\"(.*?)\"/)||[])&&e[1]&&!isNaN(+e[1])&&(s.columns=+e[1]),/size/.test(a)&&(e=a.match(/size\=\"(.*?)\"/)||[])&&e[1]&&new RegExp(e[1].toLowerCase()).test("small medium large full")&&(s.size=e[1].toLowerCase()),/link/.test(a)&&(e=a.match(/link\=\"(.*?)\"/)||[])&&e[1]&&new RegExp(e[1].toLowerCase()).test("post file none")&&(s.link=e[1].toLowerCase()),t[1].split(",")),h=c.length,p=0;p<c.length;p++)c[p]=+c[p],wp.media.attachment(c[p])&&wp.media.attachment(c[p]).attributes&&wp.media.attachment(c[p]).attributes.sizes||h--;var d=function(){var t,e=u('div[data-pointer="tmp_gallery-'+r+'"]')[0]||!1;return!!e&&!(!(t=o(c))||!t.length)&&(m[n]||(m[n]=t),e.innerHTML=t.join(""),void(i.callbacks&&i.callbacks.widget&&"function"==typeof i.callbacks.widget&&i.callbacks.widget()))};h!==c.length?wp.media.query({post__in:c}).more().then(function(){setTimeout(function(){d(),u(window).trigger("resize.mmd_preview")},250)}):setTimeout(function(){d(),u(window).trigger("resize.mmd_preview")},250)}return""},a.prototype.convertHTMLImage=function(t,e){var i=t.match(/<img(.*?)>\{([^\}]+)\}/),n=this.hashString(t);if(m&&m[n])return m[n].join("");if(!i||i.length<2)return t.replace(/\{[^\}]+\}/,"");var a=t.match(/<img(.*?)>\{([^\}]+)\}/g);if(a&&a.length){for(var r,s=0,o=[],l="",c=[],h="";s<a.length;s++){var p,d=(d=t.match('<a href="(.*?)"[^>]*>'+i[s]))&&0<d.length?d[1]:"",o=a[s].match(/<img(.*?)>\{(.*?)\}/),l="<figure"+(this.extractExtra(a[2])||"")+">";d&&d.length&&(l+='<a href="'+d+'" target="_blank">'),l+="<img"+o[1]+">",c=o[1].match(/alt\=\"(.*?)\"/),r=o[1].match(/src\=\"(.*?)-(\d+)x(\d+)\.(\w+)\"/),h="",c&&c[1]&&/--/.test(c[1])&&(c=(p=c[1].split("--"))[0].replace(/^\s*|\s*$/,""),h=p[1].replace(/^\s*|\s*$/,"")),d&&d.length&&(l+="</a>"),h&&h.length&&(l=(l=l.replace(/class="(.*?)"/,'class="wp-block-image wp-caption $1"')).replace(/alt=".*?"/,'alt="'+c+'"'),l+='<figcaption class="wp-caption-text wp-element-caption">'+h+"</figcaption>"),r&&r[2]&&!isNaN(+r[2])&&(l=l.replace(/<figure/,'<figure style="width:'+r[2]+'px"')),l+="</figure>",t=d&&d.length?t.replace(new RegExp("<a\\s[^>]*>"+a[s]+"</a>","g"),l):t.replace(a[s],l)}m[n]=[t]}return t},a.prototype.convertAudioShortcode=function(t,e){var i=this.hashString(t=t||"");return m&&m[i]?m[i].join(""):(t=t.match(/^\[audio.*?src\=\"(.*?)\".*?\]\[\/audio\]$/)||!1)&&t.length&&0<t.length?(e='<audio class="wp-audio-shortcode" id="audio-'+e+'" preload="none" ',e+='style="width: 100%;" controls="controls" src="'+t[1]+'"></audio>',m[i]=[e],e):""},a.prototype.convertVideoShortcode=function(t,e){var i,n,a,r,s=this.hashString(t=t||"");return m&&m[s]?m[s].join(""):(i=t.match(/src\=\"(.*?)\"/)||!1,n=t.match(/width\=\"(.*?)\"/)||!1,t=t.match(/height\=\"(.*?)\"/)||!1,a="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' version='1.1' ",r="%3Crect ",i&&i.length&&0<i.length?(e='<video class="wp-video-shortcode" id="video-'+e+'" preload="none" ',e+='style="width: 100%; height: auto;" controls="controls" ',n&&n.length&&0<n.length&&(e+='width="'+n[1]+'" ',a+="width='"+n[1]+"' ",r+="width='"+n[1]+"' "),t&&t.length&&0<t.length&&(e+='height="'+t[1]+'" ',a+="height='"+t[1]+"' ",r+="height='"+t[1]+"' "),e=e+('poster="'+(a+="%3E"+(r+=" fill='%23EDEDED'%3E%3C/rect%3E")+"%3C/svg%3E"))+'" src="'+i[1]+'"></video>',m[s]=[e],e):"")},a.prototype.renderVideoPlaylist=function(s,o){var i=this,t=(s||"").match(/ids\=\"(.*?)\"/);if(!t||!t[1])return"";var n=i.hashString(s);if(m&&m[n])return m[n].join("");for(var e,a=function(t){for(var e,i=[],n=0;n<t.length;n++)(e=wp.media.attachment(+t[n]).attributes).url&&(e={src:e.url,type:e.mime,title:e.title,caption:e.caption,description:e.description,meta:e.meta,dimensions:{original:{width:e.width,height:e.height},resized:{width:640,height:Math.ceil(640*e.height/e.width)}},image:{src:e.image.src,width:e.image.width,height:e.image.height},thumb:{src:e.thumb.src,width:e.thumb.width,height:e.thumb.height}},i.push(e));if(!i.length)return"";var a=['<div id="playlist-'+o+'" class="wp-playlist wp-video-playlist wp-playlist-light" data-shortcode="'+encodeURIComponent(s)+'">'];a.push('<video controls="controls" preload="none" width="'+i[0].dimensions.resized.width+'" height="'+i[0].dimensions.resized.height+'"></video>'),a.push('<div class="wp-playlist-next"></div>'),a.push('<div class="wp-playlist-prev"></div>'),a.push('<script type="application/json" class="wp-playlist-script">'),a.push('{"type":"video","tracklist":true,"tracknumbers":true,"images":true,"artists":true,"tracks":[');for(var r=0;r<i.length;r++)a.push((0<r?",":"")+JSON.stringify(i[r]));return a.push("]}<\/script>"),a.push("</div>"),a},r=function(){var t,e=u('div[data-pointer="tmp_video_playlist-'+o+'"]')[0]||!1;return!!e&&!(!(t=a(l))||!t.length)&&(e.innerHTML=t.join(""),window.wp&&window.wp.playlist&&"function"==typeof window.wp.playlist.initialize&&setTimeout(function(){window.wp.playlist.initialize(),setTimeout(function(){m[n]||(m[n]=[e.innerHTML])},250)},250),void(i.callbacks&&i.callbacks.widget&&"function"==typeof i.callbacks.widget&&i.callbacks.widget()))},l=t[1].split(","),c=l.length,h=0;h<l.length;h++)l[h]=+l[h],(e=wp.media.attachment(l[h]).attributes||!1)&&e.url&&(!e.url||e.url.length)||c--;return c<l.length?wp.media.query({post__in:l}).more().then(function(t){setTimeout(r,250)}):setTimeout(r,250),!0},a.prototype.renderAudioPlaylist=function(s,o){var i=this,t=(s||"").match(/ids\=\"(.*?)\"/);if(!t||!t[1])return"";var n=i.hashString(s);if(m&&m[n])return m[n].join("");for(var e,a=function(t){for(var e,i=[],n=0;n<t.length;n++)(e=wp.media.attachment(+t[n]).attributes).url&&(e={src:e.url,type:e.mime,title:e.title,caption:e.caption,description:e.description,meta:e.meta,image:{src:e.image.src,width:e.image.width,height:e.image.height},thumb:{src:e.thumb.src,width:e.thumb.width,height:e.thumb.height}},i.push(e));if(!i.length)return"";var a=['<div id="playlist-'+o+'" class="wp-playlist wp-audio-playlist wp-playlist-light" data-shortcode="'+encodeURIComponent(s)+'">'];a.push('<audio controls="controls" preload="none" width="582"></audio>'),a.push('<div class="wp-playlist-next"></div>'),a.push('<div class="wp-playlist-prev"></div>'),a.push('<script type="application/json" class="wp-playlist-script">'),a.push('{"type":"audio","tracklist":true,"tracknumbers":true,"images":true,"artists":true,"tracks":[');for(var r=0;r<i.length;r++)a.push((0<r?",":"")+JSON.stringify(i[r]));return a.push("]}<\/script>"),a.push("</div>"),a},r=function(){var t,e=u('div[data-pointer="tmp_audio_playlist-'+o+'"]')[0]||!1;return!!e&&!(!(t=a(l))||!t.length)&&(e.innerHTML=t.join(""),window.wp&&window.wp.playlist&&"function"==typeof window.wp.playlist.initialize&&setTimeout(function(){window.wp.playlist.initialize(),setTimeout(function(){m[n]||(m[n]=[e.innerHTML])},250)},250),void(i.callbacks&&i.callbacks.widget&&"function"==typeof i.callbacks.widget&&i.callbacks.widget()))},l=t[1].split(","),c=l.length,h=0;h<l.length;h++)l[h]=+l[h],(e=wp.media.attachment(l[h]).attributes||!1)&&e.url&&(!e.url||e.url.length)||c--;return c<l.length?wp.media.query({post__in:l}).more().then(function(t){setTimeout(r,250)}):setTimeout(r,250),!0},a.prototype.renderLatexSnippets=function(t,e){var i=this.hashString(t);if(m&&m[i])return m[i].join("");var n=t.match(/\${1,2}([^\$]+)\${1,2}/);if(!n||!n[1])return!1;var a=n[1].replace(/<br\s*\/*>/g,"\n").replace(/(^\n|\n$)/,""),r=u('span[data-pointer="tmp_latex-'+e+'"]')[0]||!1;if(!r)return!1;if(r.parentNode)for(var s,o=0;o<3;){if("CODE"===((s=r.parentNode||{}).tagName||"").toUpperCase()||/hljs/.test(s.className||""))return r.parentNode.removeChild(r),!1;o++}return r&&!/tmp_ui_ready/.test(r.className)&&(r.className+=" tmp_ui_ready",setTimeout(function(){if(!r)return!1;var t=!!/\$\$/.test(n);window.katex?katex.render(a,r,{displayMode:t,throwOnError:!1}):window.MathJax&&(MathJax.tex2chtml&&"function"==typeof MathJax.tex2chtml?r.appendChild(MathJax.tex2chtml(a),{em:16,ex:8,display:t}):MathJax.tex2svg&&"function"==typeof MathJax.tex2svg&&r.appendChild(MathJax.tex2svg(a),{em:16,ex:8,display:t})),m[i]||(m[i]=[r.innerHTML])},250)),!0},a.prototype.renderMermaidSnippets=function(t,e){var i,n,a=this.hashString(t);return m&&m[a]?m[a].join(""):!(!(t=t.match(/^<[a-z]+[^>]*>([\s\S]+)<\/[a-z]+>$/))||!t[1]||(i=t[1].replace(/<br\s*\/*>/g,"\n").replace(/(^\n|\n$)/,""),n=u('pre[data-pointer="tmp_mermaid-'+e+'"]')[0]||!1,!i)||!n||(n&&!/tmp_ui_ready/.test(n.className)&&(n.className+=" tmp_ui_ready",setTimeout(function(){if(!n||!window.mermaid)return!1;var t=document.createElement("div");t.setAttribute("id",n.getAttribute("id")+e),mermaid.render(t.id,u("<textarea></textarea>").html(i).text()).then(function(t){m[a]||(m[a]=[t.svg]),setTimeout(function(){n.innerHTML=t.svg},50)}).catch(function(t){console.error("Mermaid rendering error:",t)})},250)),0))},a.prototype.renderCodeFencesSnippets=function(t,e){var i,n,a,r=this.hashString(t);return m&&m[r]?m[r].join(""):!(!(t=t.match(/^<pre[^>]*>([\s\S]+)<\/pre>$/))||!t[1]||!(i=u('div[data-pointer="tmp_codefences-'+e+'"]')[0]||!1)||(n=0,a=function(){return!(!i||!window.Prism)&&(i.firstChild&&(i.firstChild.className||"").length?void(m[r]||(m[r]=[i.innerHTML])):(10<++n||setTimeout(a,250),!1))},i&&!/tmp_ui_ready/.test(i.className)&&(i.className+=" tmp_ui_ready",setTimeout(a,250)),0))},window.MmdPreview=function(t){var e=(t=t||{}).callbacks||{},t=t.base_url||"",i=function(){},n=function(){};return e.widget&&"function"==typeof e.widget||(e.widget=i),e.multisel&&"function"==typeof e.multisel||(e.multisel=n),new a({base_url:t,callbacks:e})}})(window.jQuery);