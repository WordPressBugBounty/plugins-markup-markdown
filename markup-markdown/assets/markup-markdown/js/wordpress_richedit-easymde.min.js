/**
 * @preserve The Markup Markdown's EasyMDE Primary Module
 * @desc Core classes to handle the markdown editor inside the Wordpress admin edit screen
 * @author Pierre-Henri Lavigne <lavigne.pierrehenri@proton.me>
 * @version 1.6.4
 * @license GPL 3 - https://www.gnu.org/licenses/gpl-3.0.html#license-text
 */
((D,N,S)=>{var I={},T={},z={},R=0;function i(e){this.todo=[],this.updating=!1,this.isRendering=!1,this.instance={},this.init(e)}function r(e){function a(e){(e=e||!1)&&(D(e).each(function(){new i(this)}),D(e).length||document.dispatchEvent(new Event("CodeMirrorSpellCheckerReady")))}if(!e)return S.addEventListener("CodeMirrorSpellCheckerReady",function(){new L,D(S.body).addClass("markupmarkdown-ready").trigger("click.mmd_body_sticky_toolbar")}),a('textarea[name="description"]'),!0;S.addEventListener("CodeMirrorSpellCheckerReady",function(){t&&!t.hasClass("ready")&&(t.addClass("ready"),new L),D(S.body).addClass("markupmarkdown-ready").trigger("click.mmd_body_sticky_toolbar")});var t=D("#wp-content-editor-container");return t.length?(a(t.find(".wp-editor-area")),!0):(t=D(".acf-input #acf-_post_content").parent()).length?(a("#acf-_post_content"),!0):void a('textarea[name="description"]')}function L(){var e=this;if(D(S.body).hasClass("mmd-options-ready"))return!1;D(S.body).addClass("mmd-options-ready");var a=0,t=D(".mmd-easymde-prefs");e.userOptions=e.getUserOptions(t),e.stickyInst=[],t.on("click",function(){a&&clearTimeout(a),a=setTimeout(function(){e.saveUserOptions(t),e.setStickyToolbar()},100)}),e.setStickyToolbar()}i.prototype.mediaUploader=function(){var e,a=this,t="";return t.length||(t=(t=N.wp&&N.wp.pluginMarkupMarkdown&&N.wp.pluginMarkupMarkdown.homeURL?N.wp.pluginMarkupMarkdown.homeURL:(e=decodeURIComponent(jQuery('script[src*="wordpress_richedit-easymde"]').attr("src")),/home_url/.test(e)?e.replace(/.*?home_url=/,"").replace(/&.*?$/,""):"/")).replace(/^(.*?)(\.[a-z]+\/).*?$/,"$1$2"),a.home_url=t),!(I&&I.title||(T=new MmdPreview({base_url:a.home_url,callbacks:{widget:function(){},multisel:function(){}}}),N.wp&&N.wp.pluginMarkupMarkdown&&"number"==typeof N.wp.pluginMarkupMarkdown.mediaUploader&&!N.wp.pluginMarkupMarkdown.mediaUploader)||(I=new MmdMedia({base_url:a.home_url,callbacks:{widget:function(e){e&&e.length&&a.mediaWidgetCallBack(e)},multisel:function(e){e&&e.length&&a.mediaMultiselCallBack(e)}}}),0))},i.prototype.core=function(e){var a=D(e||"#none");if(!a.length||a.hasClass("mmd-running"))return!1;!a.attr("id")&&a.attr("name")&&a.attr("id",a.attr("name").replace(/[^a-zA-Z0-9]/g,"")),a.addClass("mmd-running").attr({"data-gramm":"false","data-gramm_editor":"false","data-enable-grammarly":"false"});function t(e,i){if(++l<=1)return!0;2===l&&d.push("|"),d.push({name:"mmd_wpsi18n_"+i.code,action:function(e){var a=n.instance.editor.codemirror.getDoc(),t=a.getSelection()||!1;if(t&&t.length)return n.instance.i18nAdded=1,a.replaceSelection('<span lang="'+i.code+'">'+t+"</span>")},className:"i18n "+i.code,text:i.code.toUpperCase(),title:i.label})}var i,n=this,r=D("body").hasClass("wp-admin")?1:0,o=0,d=((a.parent().hasClass("acf-input")||a.parents("form-field")||/^(acf|bbp)[-_]{1}/.test(a.attr("id")||""))&&(o=1),i=n.mediaUploader(),[]),s={mmd_bold:{action:EasyMDE.toggleBold,className:"mmd_fa mmd_fa-bold"},mmd_italic:{action:EasyMDE.toggleItalic,className:"mmd_fa mmd_fa-italic"},mmd_strikethrough:{action:EasyMDE.toggleStrikethrough,className:"mmd_fa mmd_fa-strikethrough"},mmd_heading:{action:EasyMDE.toggleHeadingSmaller,className:"mmd_fa mmd_fa-header mmd_fa-heading"},"mmd_heading-smaller":{action:EasyMDE.toggleHeadingSmaller,className:"mmd_fa mmd_fa-header mmd_fa-heading"},"mmd_heading-bigger":{action:EasyMDE.toggleHeadingBigger,className:"mmd_fa mmd_fa-lg mmd_fa-header mmd_fa-heading"},"mmd_heading-1":{action:EasyMDE.toggleHeading1,className:"mmd_fa mmd_fa-header mmd_fa-heading header-1"},"mmd_heading-2":{action:EasyMDE.toggleHeading2,className:"mmd_fa mmd_fa-header mmd_fa-heading header-2"},"mmd_heading-3":{action:EasyMDE.toggleHeading3,className:"mmd_fa mmd_fa-header mmd_fa-heading header-3"},mmd_code:{action:EasyMDE.toggleCodeBlock,className:"mmd_fa mmd_fa-code"},mmd_quote:{action:EasyMDE.toggleBlockquote,className:"mmd_fa mmd_fa-quote-left"},"mmd_unordered-list":{action:EasyMDE.toggleUnorderedList,className:"mmd_fa mmd_fa-list-ul"},"mmd_ordered-list":{action:EasyMDE.toggleOrderedList,className:"mmd_fa mmd_fa-list-ol"},"mmd_clean-block":{action:EasyMDE.cleanBlock,className:"mmd_fa mmd_fa-eraser"},mmd_link:{action:EasyMDE.drawLink,className:"mmd_fa mmd_fa-link"},mmd_image:{action:EasyMDE.drawImage,className:"mmd_fa mmd_fa-picture-o"},"mmd_upload-image":{action:EasyMDE.drawUploadedImage,className:"mmd_fa mmd_fa-image"},mmd_table:{action:EasyMDE.drawTable,className:"mmd_fa mmd_fa-table"},"mmd_horizontal-rule":{action:EasyMDE.drawHorizontalRule,className:"mmd_fa mmd_fa-minus"},mmd_preview:{action:EasyMDE.togglePreview,className:"mmd_fa mmd_fa-eye no-disable"},"mmd_side-by-side":{action:EasyMDE.toggleSideBySide,className:"mmd_fa mmd_fa-columns no-disable no-mobile"},mmd_fullscreen:{action:EasyMDE.toggleFullScreen,className:"mmd_fa mmd_fa-arrows-alt no-disable no-mobile"},mmd_undo:{action:EasyMDE.undo,className:"mmd_fa mmd_fa-undo"},mmd_redo:{action:EasyMDE.redo,className:"mmd_fa mmd_fa-redo"},mmd_guide:{action:function(){return window.open("https://www.markdownguide.org/basic-syntax/","_blank")},className:"mmd_fa mmd_fa-question-circle"}},m=(EasyMDE.wpsImage=function(e){if((z=n).widgetCounter||(z.widgetCounter=1),!I||!I.title){if(I&&"function"!=typeof I.initialize)return!1;I.initialize()}I.open()},{disabled:1}),l=(N.wp&&N.wp.pluginMarkupMarkdown&&N.wp.pluginMarkupMarkdown.spellChecker&&"object"!=typeof(m=N.wp.pluginMarkupMarkdown.spellChecker)&&(m={disabled:1}),0),c="ltr";/mmd_dir\=(ltr|rtl)/.test(window.location.search||"")?c=window.location.search.match(/mmd_dir\=(ltr|rtl)/)[1]:(1<(window.isRTL||0)||"rtl"===(document.documentElement.dir||""))&&(c="rtl"),EasyMDE.switchHTMLDir=function(){var e=c&&"ltr"===c?"rtl":"ltr";document.location.href=[document.location.href.replace(/mmd_dir=[a-z]+/,""),"&mmd_dir="+e].join("")},s.mmd_rtltextdir={action:EasyMDE.switchHTMLDir,className:"mmd_fa"+("rtl"===c?"s":"r")+" mmd_fa-caret-square-left"},s.mmd_ltrtextdir={action:EasyMDE.switchHTMLDir,className:"mmd_fa"+("ltr"===c?"s":"r")+" mmd_fa-caret-square-right"};for(var p=0,u="",g="",f=n.toolbarButtons;p<f.length;p++)u=f[p],/pipe/.test(u)?d.push("|"):/spell[-_]*check/.test(u)?m.disabled||D.each(m,t):/wps[-_]*image/.test(u)?0<i?d.push({name:"wpsimage",action:EasyMDE.wpsImage,className:"mmd_fa mmd_fa-images",title:mmd_wpr_vars&&mmd_wpr_vars.wpsimage?mmd_wpr_vars.wpsimage:"Image"}):d.push("image"):s[g=u.replace("_","-").replace("mmd-","mmd_")]?(s[g].name=g,mmd_wpr_vars&&mmd_wpr_vars[g]&&(s[g].title=mmd_wpr_vars[g]),d.push(s[g])):d.push(g.replace("mmd_",""));if(l<1&&(m={disabled:1}),o||!r){var _=[];if(/desc|acf|bbp/.test(a.attr("name")||""))for(var h=0,k=!1;h<d.length;h++)d[h]&&d[h].name&&/bold|italic|pipe|list|link|image|preview|guide/.test(d[h].name||"")?(k=!1,_.push(d[h])):"|"!==d[h]||k||(k=!0,_.push(d[h]));else for(var w=0;w<d.length;w++)/fullscreen|side/.test(d[w]||"")||_.push(d[w]);d=_}var y={autoDownloadFontAwesome:!1,element:a.get(0),toolbar:d,renderingConfig:{codeSyntaxHighlighting:!1},previewRenderedMarkdown:function(e,a){return T.flushQueue(),e=n.previewRender(e,a),setTimeout(function(){T.runQueue(),window.Prism&&"function"==typeof window.Prism.highlightAll&&Prism.highlightAll(),D(N).trigger("resize.mmd_win_sticky_toolbar")},10),e},direction:c},M=(m&&"none"!==m&&!m.disabled?y.spellChecker=function(e){e.language=m,CustomCodeMirrorSpellChecker(e)}:y.spellChecker=!1,N.wp.pluginMarkupMarkdown||(N.wp.pluginMarkupMarkdown={}),N.wp.pluginMarkupMarkdown.instances||(N.wp.pluginMarkupMarkdown.instances=[]),N.wp.pluginMarkupMarkdown.headingLevels&&(y.parsingConfig=y.parsingConfig||{},y.parsingConfig.headingLevels=N.wp.pluginMarkupMarkdown.headingLevels),n.fieldNumber=R++,D(e).val().match(/\"myset.*?\s/g));if(M&&M.length){for(var b,v=0,E=0;E<M.length;E++)v<(b=parseInt(M[E].replace(/\d_/,"").replace(/[^\d]+/,""),10))&&(v=b);n.widgetCounter=v+1}function C(){var e;y.parsingConfig&&y.parsingConfig.headingLevels&&-1===y.parsingConfig.headingLevels.indexOf(1)&&(e=(e=(e=a.val()).replace(/([\s\t]*)([\\]+)([\#]{1})\s/g,"$1$3 ")).replace(/^[\#]{1}\s/g,"\\# ").replace(/([\s\t]+)([\#]{1})\s/g,"$1\\# "),a.val(e)),n.instance.editor=new EasyMDE(y),n.instance.editor.codemirror.on("change",function(){a.val(n.instance.editor.value())}),N.wp.pluginMarkupMarkdown.instances.push(n.instance.editor)}!m||m.disabled&&1===m.disabled||"none"===m?(C(),document.dispatchEvent(new Event("CodeMirrorSpellCheckerReady")),0<o?a.closest(".acf-input, .form-field").addClass("ready"):(D("#wp-content-editor-container").addClass("ready"),new L,D(S.body).addClass("markupmarkdown-ready"))):(C(),"function"==typeof MmdSpellWizard&&new MmdSpellWizard(n.instance.editor.codemirror)),0<o&&setTimeout(function(){n.instance.editor.codemirror.refresh()},250)},i.prototype.mediaWidgetCallBack=function(e){z.widgetCounter++;var a=z.instance.editor.codemirror.getDoc(),t=a.getCursor();return a.replaceRange(e,t)},i.prototype.mediaMultiselCallBack=function(e){var a=z.instance.editor.codemirror.getDoc(),t=a.getCursor();return a.replaceRange(e.replace(/myset\%d/g,"myset"+z.fieldNumber+"_"+z.widgetCounter),t)},i.prototype.previewRender=function(e,a){function t(e,a){return("tmp_node"+999999999*Math.random()).replace(/\.|\,/,"")}var i=this,n=(e=e.replace(/<h\d[^\>]*>.*?\{[^\}]+\}<\/h\d>/g,function(e){return T.processTask("convertHeading",e)}),0),r=(e=(e=(e=(e=(e=e.replace(/\[gallery([^\]]*)\]/g,function(e){return n++,'<div id="'+t()+'" class="tmp_media" data-pointer="tmp_gallery-'+n+'">'+T.add2Queue("gallery",e,n)+"</div>"})).replace(/\[playlist([^\]]*)\]/g,function(e){return n++,/type\=\"video\"/.test(e)?'<div id="'+t()+'" class="tmp_media" data-pointer="tmp_video_playlist-'+n+'">'+T.add2Queue("videoPlaylist",e,n)+"</div>":'<div id="'+t()+'" class="tmp_media" data-pointer="tmp_audio_playlist-'+n+'">'+T.add2Queue("audioPlaylist",e,n)+"</div>"})).replace(/<a.*?><img.*?>\{[^\}]+\}<\/a>/g,function(e){return T.processTask("convertImage",e,!1)})).replace(/<img.*?>\{[^\}]+\}/g,function(e){return T.processTask("convertImage",e,!1)})).replace(/<p><figure/,"<figure").replace(/<\/figure><\/p>/,"</figure>"),0),o=(e=e.replace(/\[audio([^\]]*)\]\[\/audio\]/g,function(e){return T.processTask("convertAudio",e,r++)}),0),d=(e=e.replace(/\[video([^\]]*)\]\[\/video\]/g,function(e){return T.processTask("convertVideo",e,o++)}),0),s=(e=e.replace(/\${1,2}[^\$]+\${1,2}/g,function(e){d++;var a=!!/^\$\$/.test(e);return'<span id="'+t()+'" class="tmp_media tmp_latex tmp_span_'+(a?"block":"inline")+'" data-pointer="tmp_latex-'+d+'">'+T.add2Queue("convertLatexFormulas",e,d)+"</span>"}),0),m=(e=e.replace(/<[a-z]+ class\=\"mermaid\">[\s\S]+?<\/[a-z]+>/g,function(e){return s++,'<pre id="'+t()+'" class="tmp_media tmp_mermaid tmp_span_block" data-pointer="tmp_mermaid-'+s+'">'+T.add2Queue("convertMermaidFormulas",e,s)+"</pre>"}),0);return e=e.replace(/<pre><code class\=\".*?\">[\s\S]+?<\/code><\/pre>/g,function(e){return m++,'<div id="'+t()+'" class="tmp_media tmp_codefences tmp_span_block" data-pointer="tmp_codefences-'+m+'">'+T.add2Queue("convertCodeFences",e,m)+"</div>"}),i.isRendering||(i.isRendering=setTimeout(function(){D(window).trigger("resize.mmd_preview"),i.isRendering=0},450)),e},i.prototype.init=function(e){var a=this;a.toolbarButtons&&a.toolbarButtons.length||!N.wp||!N.wp.pluginMarkupMarkdown||!N.wp.pluginMarkupMarkdown.toolbarButtons?a.toolbarButtons=["bold","italic","heading","spell-checker","pipe","quote","unordered-list","ordered-list","pipe","link","wpsimage","table","pipe","fullscreen","side-by-side","preview","guide"]:a.toolbarButtons=N.wp.pluginMarkupMarkdown.toolbarButtons,a.core(e)},D(S).ready(function(){D(S.body).addClass("easymde");var e=1,a=0;if(wp&&wp.pluginMarkupMarkdown&&(void 0===wp.pluginMarkupMarkdown.primaryArea||wp.pluginMarkupMarkdown.primaryArea&&!isNaN(parseInt(wp.pluginMarkupMarkdown.primaryArea,10))||(e=0),wp.pluginMarkupMarkdown.spellChecker)){var t,i=wp.pluginMarkupMarkdown.spellChecker,n=!0;for(t in i)i.hasOwnProperty(t)&&(n=!1);n||(a=1)}e&&(D("#wp-content-editor-container").addClass("markupmarkdown"),D(".acf-input #acf-_post_content").parent().addClass("markupmarkdown")),a?(S.addEventListener("CodeMirrorDictionariesReady",function(){r(e)}),CustomCodeMirrorSpellChecker(wp.pluginMarkupMarkdown.spellChecker)):r(e)}),N.MarkupMarkdown=i,L.prototype.getUserOptions=function(e){var a={};return e.find('input[type="checkbox"]').each(function(){a[this.id||"none"]=this.checked?this.value:0}),a},L.prototype.saveUserOptions=function(e){this.userOptions=this.getUserOptions(e),D.post(N.ajaxurl,{action:"mmduser-editoptions",options:this.userOptions,mmdeditoptionsnonce:D("#mmdeditoptionsnonce").val()})},L.prototype.setStickyToolbar=function(){var e,a,t,i=this,n=parseInt(i.userOptions.mmd_sticky_toolbar||0,10),r=0,o=D(N).height()-(D("#wpadminbar ").height()||0),d=function(e){var a;return!(e.hasClass("sicky-toolbar")||(a=e.find(".editor-toolbar:eq(0)"),e.height()-a.height()<o)||(r=1,e.addClass("sicky-toolbar"),a.addClass("mmd-sticky"),e.find(".editor-endbar").length||e.append(D('<div class="editor-endbar"></div>')),i.stickyInst.push(new N.Waypoint.Sticky({element:a[0]})),i.stickyInst.push(new N.Waypoint({element:e.children(".editor-endbar")[0],handler:function(e){"down"===e?D(this.element).parent().addClass("mmd-sticky-end"):"up"===e&&D(this.element).parent().removeClass("mmd-sticky-end")},offset:"bottom-in-view"})),0))},s=function(){return!(!i.stickyInst||!i.stickyInst.length||(r=0,i.stickyInst=i.stickyInst||[],i.stickyInst.length&&(N.Waypoint.destroyAll(),i.stickyInst=[]),D(".EasyMDEContainer ").each(function(){var e=D(this).removeClass("sicky-toolbar").removeClass("mmd-sticky-end");e.find(".editor-toolbar").removeClass("mmd-sticky").each(function(){D(this).removeAttr("style"),D(this).parent().hasClass("sticky-wrapper")&&e.prepend(this)}),e.find(".sticky-wrapper").remove()}),0))};n?(D(".EasyMDEContainer").each(function(){d(D(this))}),D(N).off("resize.mmd_win_sticky_toolbar").on("resize.mmd_win_sticky_toolbar",function(){D(".EasyMDEContainer").each(function(){D(this).find(".editor-toolbar.mmd-sticky").css({width:Math.ceil(D(this).width())-22})})}).trigger("resize.mmd_win_sticky_toolbar"),e=0,t=function(){e=e||setTimeout(function(){D(".editor-toolbar.fullscreen").length?s():r?N.Waypoint.refreshAll():setTimeout(function(){D(".EasyMDEContainer").each(function(){d(D(this))}),D(N).trigger("resize.mmd_win_sticky_toolbar")},50),e=0},450)},D(S.body).off("click.mmd_body_sticky_toolbar").on("click.mmd_body_sticky_toolbar",function(e){t(),a=D(e.target).closest(".EasyMDEContainer")}),D(S).off("keyup.mmd_doc_sticky_toolbar").on("keyup.mmd_doc_sticky_toolbar",function(e){t(),e.keyCode&&13===e.keyCode&&a&&a.length&&!a.hasClass("sicky-toolbar")&&setTimeout(function(){o=D(N).height()-(D("#wpadminbar ").height()||0),d(a),D(N).trigger("resize.mmd_win_sticky_toolbar")},1e3)})):(D(S).off("keyup.mmd_doc_sticky_toolbar"),D(S.body).off("click.mmd_body_sticky_toolbar"),D(N).off("resize.mmd_win_sticky_toolbar"),s())}})(window.jQuery,window,document);